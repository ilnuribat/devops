- name: Docker login
  docker_login:
    registry: docker.scis.xyz
    username: "{{ docker_login }}"
    password: "{{ docker_password }}"
    state: present
- name: build docker image
  docker_image:
    name: docker.scis.xyz/stimul
    state: present
    tag: "{{ hostvars['localhost']['last_commit'] }}"
    path: /var/lib/guov/stimul
    push: true
  register: built_image
- name: built image short id
  set_fact:
    short_id: "{{ hostvars.localhost.built_image.image.Id[7:19] }}"
- name: clear all old images
  shell: "docker images | grep stimul | grep -v {{ hostvars.localhost.short_id }} | awk '{ print $3 }' | xargs docker rmi -f || true"
