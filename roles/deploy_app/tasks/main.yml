- name: .env
  template:
    src: env.secret
    dest: /var/lib/guov/backend/.env
- name: login to registry
  docker_login:
    registry: docker.scis.xyz
    username: "{{ docker_login }}"
    password: "{{ docker_password }}"
    state: present
- name: pull image
  docker_image:
    name: docker.scis.xyz/stimul
    tag: "{{ hostvars['localhost']['last_commit'] }}"
    state: present

- name: start container
  docker_container:
    name: "stimul_{{ item }}"
    state: started
    image: "docker.scis.xyz/stimul:{{ hostvars['localhost']['last_commit'] }}"
    network_mode: host
    restart_policy: always
    recreate: true
    env_file: /var/lib/guov/backend/.env
    env:
      MICROSERVICES: "{{ item }}"
  loop:
    # - task
    # - chat
    - main
  